let scriptExecutionState={isActive:null,reader:!1,book:"start"};async function executeScriptOnce(t=!1){try{var e=await getCurrentTab(),a=getBookUrl(e.url),r=e.id,i=t?"startReadeFun":"startReadeNextPage";if(scriptExecutionState.book.split("/").length+1>e.url.split("/").length||!e.url.startsWith(scriptExecutionState.book)&&!t)return updateState({book:"",isActive:null,reader:!1}),console.log("Different book, stop execution"),!1;try{return await chrome.tabs.sendMessage(e.id,{action:i}),setNewHistory(e.title,e.url),updateState({reader:!0}),console.log("upload page"),!0}catch(t){}return await chrome.scripting.executeScript({target:{tabId:e.id},files:["/js/script.js"]}),updateState({book:a,isActive:r,reader:!0}),chrome.tabs.sendMessage(e.id,{action:i,value:a}),setNewHistory(e.title,e.url),await setReadingList(e),!0}catch(t){return console.error("Error executing script:",t),!1}}async function adjustParagraphCount(t){var e=await getCurrentTab();chrome.tabs.sendMessage(e.id,{action:"objustParagraphs",value:t})}function getBookUrl(t){var t=new URL(t),e=t.pathname.split("/").filter(Boolean),e=(1<e.length&&e.pop(),"/"+e.join("/"));return t.origin+e}async function getFindBook(t){var e=await chrome.readingList.query({});if(0!==e.length){var a=getBookUrl(t);for(const r of e)if(r.url.includes(a))return r.url}}async function setReadingList(t){var e=await getFindBook(t.url);e?chrome.readingList.updateEntry({title:t.title,url:e,hasBeenRead:!1}):chrome.readingList.addEntry({title:t.title,url:t.url,hasBeenRead:!1})}async function getStorageData(t){return new Promise(e=>{chrome.storage.sync.get([t],t=>{e(t.history)})})}async function setStorageData(e,a){return new Promise(t=>{chrome.storage.sync.set({[e]:a},()=>{t()})})}async function setNewHistory(t,e){if(e&&t){var a=await getStorageData("history")||[],r=e.split("/");const i=r.slice(0,r.length-1).join("/");r=a.filter(t=>t.bookLink!==i);await setStorageData("history",[{name:150<t.length?t.substring(0,147)+"...":t,link:e,bookLink:i},...r].slice(0,20))}}async function loadState(){var t=(await chrome.storage.sync.get("scriptExecutionState"))["scriptExecutionState"];t&&Object.assign(scriptExecutionState,t)}function updateState(t){Object.assign(scriptExecutionState,t),saveState()}function saveState(){chrome.storage.sync.set({scriptExecutionState:scriptExecutionState})}async function getCurrentTab(){var[t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});return t}chrome.runtime.onStartup.addListener(loadState),chrome.runtime.onInstalled.addListener(loadState),loadState(),chrome.commands.onCommand.addListener(async t=>{"com-start"===t?(console.log("Command received: ",t,scriptExecutionState),scriptExecutionState.reader?(chrome.storage.sync.set({reader:null}),updateState({reader:!1})):await executeScriptOnce(!0)):"com-add-p"===t?adjustParagraphCount(!0):"com-rem-p"===t&&adjustParagraphCount(!1)}),chrome.runtime.onMessage.addListener(async t=>{"firstTimeScript"===t.action?await executeScriptOnce(!0):"stopScript"===t.action&&(console.log(scriptExecutionState,"stopScript #"+scriptExecutionState.book),updateState({reader:!1}),await setReadingList(await getCurrentTab()))}),chrome.webNavigation.onCompleted.addListener(async t=>{0===t.frameId&&console.log("webNavigation ",{details:t,state:scriptExecutionState}),scriptExecutionState.isActive===t.tabId&&0===t.frameId&&(console.log("webNavigation onCompleted"),await executeScriptOnce(!1))}),chrome.tabs.onRemoved.addListener(t=>{scriptExecutionState.isActive===t&&updateState({isActive:null})});
const btnStartReader=document.getElementById("startReader"),historyMenu=document.getElementById("historyMenu"),toggleBtn=document.getElementById("toggleHistory");let reader=null,isInitialized=!1;function isReaderActive(e){return!!e&&(e=new Date(e),new Date<e)}function updateReaderButton(e){e=isReaderActive(e);btnStartReader.textContent=e?"Stop":"Play",btnStartReader.setAttribute("aria-pressed",e.toString())}function updateNavigatorLink(e){var t=document.querySelector(".book-popup");t&&(t.textContent=e?.book||"Last started reader",t.href=e?.bookURL||"#",e?.bookURL||(t.setAttribute("aria-disabled","true"),t.style.pointerEvents="none"))}async function loadHistory(){try{var{history:e=[]}=await chrome.storage.sync.get("history");e.length?historyMenu.innerHTML=e.map(e=>`
        <a href="${escapeHtml(e.link)}" 
           target="_blank" 
           rel="noopener noreferrer"
           class="history-item">
          ${escapeHtml(e.name)}
        </a>
      `).join(""):historyMenu.innerHTML='<p class="empty-state">No reading history yet</p>'}catch(e){console.error("Failed to load history:",e),historyMenu.innerHTML='<p class="error">Failed to load history</p>'}}function escapeHtml(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}async function handleReaderToggle(){try{isReaderActive(reader)?(await chrome.runtime.sendMessage({action:"stopScript"}),reader=null,await chrome.storage.sync.set({reader:reader})):(await chrome.runtime.sendMessage({action:"firstTimeScript"}),window.close())}catch(e){console.error("Failed to toggle reader:",e),btnStartReader.textContent="Error - Try again",setTimeout(()=>updateReaderButton(reader),2e3)}}async function init(){if(!isInitialized){isInitialized=!0;try{var{reader:e,navigator:t}=await chrome.storage.sync.get(["reader","navigator"]);updateReaderButton(reader=e),updateNavigatorLink(t),btnStartReader.addEventListener("click",handleReaderToggle),toggleBtn.addEventListener("click",async()=>{historyMenu.classList.contains("hidden")?(await loadHistory(),historyMenu.classList.remove("hidden"),toggleBtn.setAttribute("aria-expanded","true")):(historyMenu.classList.add("hidden"),toggleBtn.setAttribute("aria-expanded","false"))})}catch(e){console.error("Failed to initialize popup:",e)}}}chrome.storage.onChanged.addListener((e,t)=>{"sync"===t&&(e.reader&&updateReaderButton(reader=e.reader.newValue),e.navigator&&updateNavigatorLink(e.navigator.newValue),e.history)&&!historyMenu.classList.contains("hidden")&&loadHistory()}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init();